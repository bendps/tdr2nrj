---
title: "Data Summary - Adélies 2018-19 - TDR"
author: "Benjamin Dupuis"
date: "07/03/2021"
output:
  html_document:
    theme: yeti
    highlight: kate
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, dpi = 300, tidy.opts=list(width.cutoff=50))
```

**Research questions - 1. Develop a tool to detect and quantify state at the dive level with low-resolution TDR data (technical) 2. How environmental variation is shaping energy balance of Adélie penguins.**

Other species :

-   Southern elephant seals and Weddell seals

    -   Categorize dives (explore, shallow, deep active etc.) *should we try categorizing dives before looking at the dive lvl? as in Dragon et al. (2012) MEPS*

        -   Bottom time

        -   Recovery time (time between 2 dives)

        -   Max depth

        -   Day/Night

    -   1 Hz resolution like us

        -   Dive phase with the bottom limit set at 80% of the max depth

        -   Descent/Ascent rate

        -   Sinuosity (seems to be equivalent to what we measure with the rolling SD of the speed)

        -   Using Broken stick method, get about 77% of accuracy

```{r preambule, message = FALSE, warning = FALSE}
rm(list=ls())

library(tidyverse); library(cowplot); library(lubridate)
library(ggthemes); library(viridis); library(scattermore)
library(ggplotlyExtra); library(zoo); library(ggforce)
library(ggExtra)
theme_set(theme_bw())

```

We work with the Adélies TDR data of the season 2018-19, with the states annotated by Marianna.

```{r load}
dive_phases <- read_rds("data/Adélie_data_18-19_EM/dive_phases_adelie_2018_19.rds")
```

This dataset regroups `r length(unique(dive_phases$tag_id))` individuals, `r length(unique(dive_phases$trip_id))` trips and `r length(unique(dive_phases$dive_id))` dives, distributed like that:

```{r distribution of dives}
dist_dives <- dive_phases %>% group_by(trip_id) %>% summarise(n_dive = sum(state_change))

hist_dive <- ggplot(dist_dives, aes(x = n_dive)) +
  geom_histogram(bins = 15) +
  labs(x = "Number of dives per individual", y = "Count") +
  theme_bw()
print(hist_dive)
```

A dive starts when an individual goes below 2m and ends when it goes above 2m again.

```{r duration of trips}
trip_duration <- dive_phases %>% 
  group_by(trip_id) %>%
  summarise(beg_trip = min(timestamp), end_trip = max(timestamp)) %>% 
  mutate(dur_trip = end_trip - beg_trip)
```

Trips are lasting on average `r round(mean(trip_duration$dur_trip), 2)` hours with a SD of `r round(sd(trip_duration$dur_trip), 2)` hours. Here is there distribution for all the individuals:

```{r plot duration trips, message = FALSE}
hist_trip_dur <- ggplot(trip_duration, aes(x = dur_trip)) +
  geom_histogram(binwidth = 1) +
  labs(x = "Duration of a trip (h)", y = "Count") +
  theme_bw() +
  scale_x_continuous(breaks = seq(from = 0, to = 70, by = 5))
print(hist_trip_dur)
```

```{r duration of dive}
dive_duration <- dive_phases %>% 
  group_by(dive_id) %>%
  summarise(beg_trip = min(timestamp), end_trip = max(timestamp)) %>% 
  mutate(dur_dive = (end_trip - beg_trip)+1)
```

Dives are lasting on average `r round(mean(dive_duration$dur_dive), 2)` seconds with a SD of `r round(sd(dive_duration$dur_dive), 2)` s. Here is there distribution for all the individuals:

We see a important number of dives lasting 1-5 sec. Those are really shallow/noisy dives (see following plots)

```{r plot duration dive, message = FALSE}
hist_dive_dur <- ggplot(dive_duration, aes(x = dur_dive)) +
  geom_histogram(binwidth = 1) +
  labs(x = "Duration of a dive (s)", y = "Count") +
  theme_bw()
print(hist_dive_dur)

#Plot data
my_scatter <- dive_phases %>% ggplot(aes(x = depth, y = dive_duration)) +
  geom_bin2d(bins = 70) +
  scale_fill_continuous(type = "viridis") +
  geom_point(col = NA) +
  labs(x = "Depth", y = "Dive duration", fill = "Count") +
  theme(legend.position = "bottom",
        text = element_text(face = "bold"))
ggMarginal(my_scatter, type = "histogram")
```

```{r depth of dives}
depth_dive <- dive_phases %>%
  group_by(dive_id) %>%
  summarise(max_depth = max(max_dive_depth),beg_trip = min(timestamp), end_trip = max(timestamp)) %>% 
  mutate(dur_dive = (end_trip - beg_trip)+1)
```

On average, the maximum depth reached is `r round(mean(depth_dive$max_depth),2)` m with a SD of `r round(sd(depth_dive$max_depth),2)` m. If we consider all the depth values, and not only the maximun, the average is `r round(mean(dive_phases$depth),2)` m with a SD of `r round(sd(dive_phases$depth),2)` m. We can compute their distribution and the correlation between the maximum depth reached and the duration of a dive.

*We might want to use max depth reached and dive duration to discriminate shallow/noisy dives and "normal" dives.*

```{r plot depth of dives, message = FALSE}
hist_dive_max_depth <- ggplot(depth_dive, aes(x = max_depth)) +
  geom_histogram(bins = 50) +
  labs(x = "Maximum depth reached during a dive", y = "Count") +
  theme_bw()
print(hist_dive_max_depth)

hist_dive_depth <- ggplot(dive_phases, aes(x = depth)) +
  geom_histogram(bins = 100) +
  labs(x = "Depth recorded at 1 Hz during dives", y = "Count") +
  theme_bw()
print(hist_dive_depth)

corr_dive_depth_dur <- ggplot(depth_dive, aes(x = dur_dive, y = max_depth)) +
  geom_point(alpha = 0.5) +
  labs(x = "Duration of the dive (s)", y = "Maximum depth reached (m)") +
  theme_bw() +
  geom_ellipse(aes(x0 = 50, y0 = 10, a = 50, b = 10, angle = pi/16), col = "red") +
  geom_ellipse(aes(x0 = 120, y0 = 50, a = 60, b = 30, angle = pi/4), col = "blue") +
  coord_fixed()
print(corr_dive_depth_dur)
```

Using this depth information, we defined 4 phase in the dives.

-   The bottom phase: when the individual is in the 20% highest depth

-   The descending phase: everything occurring before the start of the bottom phase

-   The ascending phase: everything occurring after the end of the bottom phase

-   The Outside Of Bottom Phase (OOBP): when the individual is not in the bottom phase and between the beginning and the end of the bottom phase.

On a typical dive, it's looking like that (plain line is sea surface, dashed is start of dives, and dotted is 80% of the maximum depth of the dive):

```{r dive phase visual}
my_dive <- dive_phases %>% filter(dive_id == 3)

my_dive_visual <- ggplot(my_dive, aes(x = timestamp, y = depth, col = phase)) +
  geom_point() +
  scale_y_reverse() +
  scale_x_datetime(date_labels = "%H:%M:%S") +
  theme_bw() +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = 2, linetype = "longdash") +
  geom_hline(yintercept = 0.8*my_dive$max_dive_depth[1], linetype = "dotted") +
  coord_cartesian(ylim = c(NA, 0)) +
  scale_color_viridis_d() +
  labs(x = "timestamp", y = "Depth (m)", col = "Diving Phases")
  
print(my_dive_visual)
```

Considering every dives of every individual, we have:

-   `r round(table(dive_phases$phase)/nrow(dive_phases)*100,2)[1]` % of Ascending

-   `r round(table(dive_phases$phase)/nrow(dive_phases)*100,2)[2]` % of Bottom

-   `r round(table(dive_phases$phase)/nrow(dive_phases)*100,2)[3]` % of Descending

-   `r round(table(dive_phases$phase)/nrow(dive_phases)*100,2)[4]` % of OOBP

Using Marianna ML annotation, we can also have an idea of when penguins are state. This annotation was done at 25 Hz, so we consider that whenever some state happens in this second, we label the second as state. This way, we have `r round(table(dive_phases$state)[1]/nrow(dive_phases)*100,2)` % of state. In these, the mean proportion of state is 0.61 with a sd of 0.38.

If we combine this state information with the diving phase, we obtain these proportion.

```{r phase repart state, message = FALSE}

hunting_df <- dive_phases%>%
  group_by(state, phase)%>%
  summarize(n=n())%>%
  filter(!is.na(phase))%>% 
  mutate(prop=round(n/sum(n),2))%>%
  subset(select=c("state","phase","prop"))%>%  
  spread(state, prop)

print(hunting_df)
```

As we expected, most of state happens in the bottom phase, and some in the ascent. A typical dive looks like that:

*Note that we might want to use the maximum depth of the dive as an extra parameter for the ML as the shallow dives seems less representative of the observed partition of state.*

```{r dive phase and state visual}
my_dive <- dive_phases %>% filter(dive_id == 1185)

my_dive_visual <- ggplot(my_dive, aes(x = timestamp, y = depth, shape = phase, col = state)) +
  geom_point() +
  scale_y_reverse() +
  scale_x_datetime(date_labels = "%H:%M:%S") +
  theme_bw() +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = 2, linetype = "longdash") +
  geom_hline(yintercept = 0.8*my_dive$max_dive_depth[1], linetype = "dotted") +
  coord_cartesian(ylim = c(NA, 0)) +
  scale_color_viridis_d() +
  labs(x = "timestamp", y = "Depth (m)", col = "Diving Phases")
  
print(my_dive_visual)
```

Finally, we also calculated 2 new parameters using the depth information:

-   The vertical speed (m.s-1): depth at time t - depth at time t-1

-   The vertical acceleration (m.s-2): speed at time t - speed at time t-1

To have not only an instant information about the movement of the animal, we calculated also a rolling mean and sd over 5 seconds of these speed and acceleration.

If we look at the distribution of each parameter individually, we can see that we have a large overlap. We also see that the rolling mean do not add much information to what already show the instantaneous speed/acceleration.

```{r visualize speed and accel, message = FALSE, warning = FALSE}
hist_vert_speed <- ggplot(dive_phases, aes(fill = state, x = vert_speed)) +
  geom_histogram(position = "identity", alpha = 0.5) +
  theme_bw() +
  labs(fill = "Activity", x = "Vertical Speed")

hist_vert_accel <- ggplot(dive_phases, aes(fill = state, x = vert_accel)) +
  geom_histogram(position = "identity", alpha = 0.5) +
  theme_bw() +
  labs(fill = "Activity", x = "Vertical Acceleration")

hist_sd_vert_speed <- ggplot(dive_phases, aes(fill = state, x = roll_sd_vert_speed)) +
  geom_histogram(position = "identity", alpha = 0.5) +
  theme_bw() +
  labs(fill = "Activity", x = "Rolling SD - Vertical Speed")

hist_sd_vert_accel <- ggplot(dive_phases, aes(fill = state, x = roll_sd_vert_accel)) +
  geom_histogram(position = "identity", alpha = 0.5) +
  theme_bw() +
  labs(fill = "Activity", x = "Rolling SD - Vertical Acceleration")

hist_mean_vert_speed <- ggplot(dive_phases, aes(fill = state, x = roll_mean_vert_speed)) +
  geom_histogram(position = "identity", alpha = 0.5) +
  theme_bw() +
  labs(fill = "Activity", x = "Rolling mean - Vertical Speed")

hist_mean_vert_accel <- ggplot(dive_phases, aes(fill = state, x = roll_mean_vert_accel)) +
  geom_histogram(position = "identity", alpha = 0.5) +
  theme_bw() +
  labs(fill = "Activity", x = "Rolling mean - Vertical Acceleration")

plot_grid(hist_vert_accel, hist_vert_speed, hist_mean_vert_accel, hist_mean_vert_speed, hist_sd_vert_accel,hist_sd_vert_speed,ncol = 2)
```

Looking at each diving phase individually allows to have a clearer view and reduce the overlap during bottom and ascend phase:

```{r visualize speed and accel with phase, message = FALSE, warning = FALSE}
dive_phases <- dive_phases %>% filter(!is.na(phase))

hist_vert_speed <- ggplot(dive_phases, aes(fill = state, x = vert_speed)) +
  geom_histogram(position = "identity", alpha = 0.5) +
  theme_bw() +
  labs(fill = "Activity", x = "Vertical Speed") +
  facet_wrap(~phase)
print(hist_vert_speed)
hist_vert_accel <- ggplot(dive_phases, aes(fill = state, x = vert_accel)) +
  geom_histogram(position = "identity", alpha = 0.5) +
  theme_bw() +
  labs(fill = "Activity", x = "Vertical Acceleration") +
  facet_wrap(~phase)
print(hist_vert_accel)
hist_sd_vert_speed <- ggplot(dive_phases, aes(fill = state, x = roll_sd_vert_speed)) +
  geom_histogram(position = "identity", alpha = 0.5) +
  theme_bw() +
  labs(fill = "Activity", x = "Rolling SD - Vertical Speed")+
  facet_wrap(~phase)
print(hist_sd_vert_speed)
hist_sd_vert_accel <- ggplot(dive_phases, aes(fill = state, x = roll_sd_vert_accel)) +
  geom_histogram(position = "identity", alpha = 0.5) +
  theme_bw() +
  labs(fill = "Activity", x = "Rolling SD - Vertical Acceleration")+
  facet_wrap(~phase)
print(hist_sd_vert_accel)
hist_mean_vert_speed <- ggplot(dive_phases, aes(fill = state, x = roll_mean_vert_speed)) +
  geom_histogram(position = "identity", alpha = 0.5) +
  theme_bw() +
  labs(fill = "Activity", x = "Rolling mean - Vertical Speed")+
  facet_wrap(~phase)
print(hist_mean_vert_speed)
hist_mean_vert_accel <- ggplot(dive_phases, aes(fill = state, x = roll_mean_vert_accel)) +
  geom_histogram(position = "identity", alpha = 0.5) +
  theme_bw() +
  labs(fill = "Activity", x = "Rolling mean - Vertical Acceleration")+
  facet_wrap(~phase)
print(hist_mean_vert_accel)
```

The best way to visualize the data with less overlap is to combine parameters, here using diving phase, and 2 different movement parameters, we obtain the following plots:

```{r 3 parameters, message = FALSE, warning = FALSE}

accel_speed <- ggplot(dive_phases, aes(y = vert_accel, x = vert_speed , col = state)) +
  geom_scattermore(position = "identity", alpha = 0.5) + 
  facet_wrap(~phase) +
  theme_bw() +
  labs(col = "Activity", x = "Vertical Speed", y = "Vertical Acceleration")
print(accel_speed)

mean_accel_speed <- ggplot(dive_phases, aes(y = roll_mean_vert_accel, x = roll_mean_vert_speed , col = state)) +
  geom_scattermore(position = "identity", alpha = 0.5) + 
  facet_wrap(~phase) +
  theme_bw() +
  labs(col = "Activity", x = "Mean Vertical Speed", y = "Mean Vertical Acceleration")
print(mean_accel_speed)

sd_accel_speed <- ggplot(dive_phases, aes(y = roll_sd_vert_accel, x = roll_sd_vert_speed , col = state)) +
  geom_scattermore(position = "identity", alpha = 0.5) + 
  facet_wrap(~phase) +
  theme_bw() +
  labs(col = "Activity", x = "SD Vertical Speed", y = "SD Vertical Acceleration")
print(sd_accel_speed)

accel_sdaccel <- ggplot(dive_phases, aes(y = vert_accel, x = roll_sd_vert_accel , col = state)) +
  geom_scattermore(position = "identity", alpha = 0.5) + 
  facet_wrap(~phase) +
  theme_bw() +
  labs(col = "Activity", x = "SD Vertical Acceleration", y = "Vertical Acceleration")
print(accel_sdaccel)

speed_sdspeed <- ggplot(dive_phases, aes(y = vert_speed, x = roll_sd_vert_speed , col = state)) +
  geom_scattermore(position = "identity", alpha = 0.5) + 
  facet_wrap(~phase) +
  theme_bw() +
  labs(col = "Activity", x = "SD Vertical Speed", y = "Vertical Speed")
print(speed_sdspeed)

```

All these leaves us with the following parameters to use:

-   Dive level

    -   Max depth

    -   Bottom/Dive duration


-   1 Hz

    -   Diving phase

    -   Vertical velocity

    -   Vertical acceleration

    -   SD of vertical speed (sinuosity)
